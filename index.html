<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Historical Stock Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0f172a; --card:#111827; --border:#1f2937;
  --text:#e5e7eb; --green:#22c55e; --red:#ef4444;
}
body { margin:0; font-family:Arial; background:var(--bg); color:var(--text);}
header {background:#020617;padding:12px;border-bottom:1px solid var(--border);}
.container {padding:16px;}
.card {background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
table {width:100%;border-collapse:collapse;}
th,td {padding:12px;border-bottom:1px solid var(--border);text-align:center;}
.pos {color:var(--green);font-weight:bold;}
.neg {color:var(--red);font-weight:bold;}
input {background:#1f2937;color:white;border:none;padding:6px 10px;border-radius:8px;}
</style>
</head>

<body>

<header>
  <span>ðŸ“… Date: 
    <input type="date" id="datePicker">
  </span>
</header>

<div class="container">
  <div class="card">
    <h3>Historical Stock Data</h3>
    <table>
      <thead>
        <tr>
          <th>Stock</th>
          <th>Low</th>
          <th>High</th>
          <th>Close</th>
          <th>% Change</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const stocks = ["IDEA","SBIN","TCS","RVNL","JPPOWER","HINDCOPPER","RBLBANK","HDFCBANK"];

// default date = yesterday
const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);
document.getElementById("datePicker").valueAsDate = yesterday;

function toUnix(dateStr){
  return Math.floor(new Date(dateStr).getTime() / 1000);
}

// Try multiple proxies (auto fallback)
async function safeFetch(url){
  const proxies = [
    u => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u),
    u => "https://corsproxy.io/?" + encodeURIComponent(u),
    u => "https://thingproxy.freeboard.io/fetch/" + u
  ];

  for (let p of proxies){
    try {
      const res = await fetch(p(url));
      if(res.ok) return await res.json();
    } catch(e){}
  }
  throw "All proxies failed";
}

// Fetch historical candle safely
async function fetchCandle(symbol, date){
  const start = toUnix(date) - 86400 * 5;
  const end   = toUnix(date) + 86400 * 2;

  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.NS?period1=${start}&period2=${end}&interval=1d`;
  const json = await safeFetch(url);

  const r = json.chart?.result?.[0];
  if(!r) return null;

  const q = r.indicators.quote[0];

  // find last valid candle
  for(let i=q.close.length-1; i>=0; i--){
    if(q.close[i] && q.low[i] && q.high[i]){
      return {
        close: q.close[i],
        low: q.low[i],
        high: q.high[i],
        prevClose: r.meta.previousClose
      };
    }
  }
  return null;
}

async function loadData(){
  const date = document.getElementById("datePicker").value;
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  for(let s of stocks){
    try{
      const d = await fetchCandle(s, date);
      if(!d){
        tbody.innerHTML += `<tr><td>${s}</td><td colspan="4">No data</td></tr>`;
        continue;
      }

      const ch = ((d.close - d.prevClose)/d.prevClose)*100;
      const cls = ch >= 0 ? "pos" : "neg";

      tbody.innerHTML += `
        <tr>
          <td>${s}</td>
          <td>${d.low.toFixed(2)}</td>
          <td>${d.high.toFixed(2)}</td>
          <td>${d.close.toFixed(2)}</td>
          <td class="${cls}">${ch.toFixed(2)}%</td>
        </tr>`;
    } catch(e){
      tbody.innerHTML += `<tr><td>${s}</td><td colspan="4">Error</td></tr>`;
    }
  }
}

document.getElementById("datePicker").addEventListener("change", loadData);
loadData();
</script>

</body>
</html>

