<!DOCTYPE html>
<html>
<head>
<title>Live NSE Stock Dashboard</title>
<style>
body {
  background: linear-gradient(#020617, #0f172a);
  color: white;
  font-family: Arial;
  padding: 20px;
}
input, button {
  background:#1e293b;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
}
button { cursor:pointer; }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th, td {
  padding:10px;
  border-bottom:1px solid #1e293b;
  text-align:center;
}
.green { color:#22c55e; font-weight:bold; }
.red { color:#ef4444; font-weight:bold; }
.yellow { color:#facc15; font-weight:bold; }
.chatbtn { background:#2563eb; padding:6px 10px; border-radius:6px; }
</style>
</head>
<body>

<h2>ðŸ“ˆ Live NSE Stock Dashboard</h2>

<button onclick="loadData()">ðŸ”„ Refresh</button>

<table>
<thead>
<tr>
<th>Stock</th>
<th>Open</th><th>High</th><th>Low</th><th>Close</th><th>%</th>
<th>RSI</th><th>EMA</th>
<th>Support</th><th>Resistance</th>
<th>Intraday (SL / Target)</th>
<th>Delivery</th>
<th>GTT</th>
<th>Ask ChatGPT</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const WORKER = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks = ["SBIN","TCS","RVNL","JPPOWER","HINDCOPPER"];

function EMA(values, p=14){
  const k = 2/(p+1);
  let ema = values[0];
  for(let i=1;i<values.length;i++) {
    ema = values[i]*k + ema*(1-k);
  }
  return ema;
}

function RSI(values, p=14){
  let gains = 0, losses = 0;
  for(let i = values.length-p; i < values.length-1; i++){
    let diff = values[i+1] - values[i];
    diff > 0 ? gains += diff : losses -= diff;
  }
  let rs = gains / (losses || 1);
  return 100 - (100 / (1 + rs));
}

async function loadData(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  for(const s of stocks){
    try {
      const res = await fetch(`${WORKER}?symbol=${s}`);
      const json = await res.json();

      const result = json.chart?.result?.[0];
      if(!result) continue;

      const q = result.indicators.quote[0];

      const open = q.open.at(-1);
      const high = q.high.at(-1);
      const low  = q.low.at(-1);
      const close = q.close.at(-1);
      const prev  = q.close.at(-2);

      const pct = (((close-prev)/prev)*100).toFixed(2);

      const closes = q.close.filter(x=>x).slice(-20);
      const highs  = q.high.filter(x=>x).slice(-20);
      const lows   = q.low.filter(x=>x).slice(-20);

      const ema = EMA(closes).toFixed(2);
      const rsi = RSI(closes).toFixed(1);

      const support = Math.min(...lows).toFixed(2);
      const resistance = Math.max(...highs).toFixed(2);

      let intraday = "NO TRADE";
      let delivery = "HOLD";
      let gtt = "-";
      let sl = "-", tgt = "-";

      if(rsi < 35){
        intraday = `BUY @ ${close.toFixed(2)}`;
        sl = (close * 0.97).toFixed(2);
        tgt = (close * 1.05).toFixed(2);
        delivery = "BUY";
        gtt = `Buy above ${resistance}`;
      }
      else if(rsi > 70){
        intraday = `SELL @ ${close.toFixed(2)}`;
        sl = (close * 1.03).toFixed(2);
        tgt = (close * 0.95).toFixed(2);
        gtt = `Sell below ${support}`;
      }

      const chatPrompt = encodeURIComponent(
        `Analyze ${s} for intraday trading. Give entry, stop loss, target and strategy.`
      );

      tbody.innerHTML += `
      <tr>
        <td><b>${s}</b></td>
        <td>${open.toFixed(2)}</td>
        <td>${high.toFixed(2)}</td>
        <td>${low.toFixed(2)}</td>
        <td>${close.toFixed(2)}</td>
        <td class="${pct>=0?'green':'red'}">${pct}%</td>
        <td>${rsi}</td>
        <td>${ema}</td>
        <td>${support}</td>
        <td>${resistance}</td>
        <td>${intraday}<br>SL: ${sl}<br>TGT: ${tgt}</td>
        <td>${delivery}</td>
        <td>${gtt}</td>
        <td>
          <a target="_blank" href="https://chat.openai.com/?q=${chatPrompt}">
            <button class="chatbtn">Ask</button>
          </a>
        </td>
      </tr>`;
    } catch (e) {
      console.error("Error loading", s, e);
    }
  }
}

loadData();
</script>
</body>
</html>
