<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Stock Dashboard Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { margin:0; background:#0f172a; color:#e2e8f0; font-family:system-ui;}
header{position:sticky;top:0;background:#020617;padding:10px;z-index:9;border-bottom:1px solid #1f2937;}
input,button{background:#0f172a;color:white;border:1px solid #334155;padding:6px;border-radius:6px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #1f2937;padding:4px;text-align:center}
th{position:sticky;top:50px;background:#020617}
tr:nth-child(even){background:#0b1220}
.green{color:#22c55e} .red{color:#ef4444} .orange{color:#f59e0b}
.badge{font-weight:bold}
</style>
</head>
<body>

<header>
  <input type="date" id="date">
  <button onclick="render()">Submit</button>
  <input placeholder="Search" oninput="render()" id="search">
  <button onclick="filter='buy';render()">Only Buy</button>
  <button onclick="filter='sell';render()">Only Sell</button>
  <button onclick="filter='all';render()">All</button>
</header>

<table>
<thead>
<tr>
<th>Stock</th><th>Signal</th><th>Trend</th>
<th>Buy</th><th>Sell</th><th>SL</th><th>Target</th>
<th>GTT Status</th>
<th>Backtest Trades</th><th>Win%</th><th>Profit%</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const API = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const STOCKS = ["SAGILITY","GROWWGOLD","JPPOWER","IDEA","BSE","GROWWSILVER","HDFCBANK","SBIN","GREAVESCOT","NTPCGREEN","TCS","KIMS","MON100","HARAFIN","RBLBANK","IRIS","MEESHO","HINDCOPPER","RVNL"];

let DB = {};
let filter="all";

async function loadData(){
  try{
    const res = await fetch(API);
    const json = await res.json();
    DB = json;
  }catch{
    generateMock();
  }
  document.getElementById("date").value = latestDate();
  render();
}

function generateMock(){
  const today=new Date();
  STOCKS.forEach(s=>{
    let p=100+Math.random()*100;
    DB[s]=[];
    for(let i=90;i>=0;i--){
      let d=new Date(today);d.setDate(today.getDate()-i);
      let o=p;
      let c=o+(Math.random()-0.5)*4;
      let h=Math.max(o,c)+Math.random()*2;
      let l=Math.min(o,c)-Math.random()*2;
      p=c;
      DB[s].push({date:d.toISOString().slice(0,10),open:o,high:h,low:l,close:c});
    }
  });
}

function latestDate(){
  return DB[Object.keys(DB)[0]].at(-1).date;
}

// INDICATORS
const EMA=(arr,p)=>{
  let k=2/(p+1),e=arr[0];
  arr.forEach(v=>e=v*k+e*(1-k));
  return e;
};
const RSI=(arr,p=14)=>{
  let g=0,l=0;
  for(let i=1;i<=p;i++){
    let d=arr[i]-arr[i-1];
    d>0?g+=d:l-=d;
  }
  let rs=g/(l||1);return 100-(100/(1+rs));
};

// STRATEGY
function signal(data){
  const c=data.map(x=>x.close);
  let e9=EMA(c.slice(-9),9), e21=EMA(c.slice(-21),21);
  let r=RSI(c.slice(-15));
  if(e9>e21 && r>55) return "BUY";
  if(e9<e21 && r<45) return "SELL";
  return "HOLD";
}

// BACKTEST ENGINE
function backtest(data){
  let trades=0,wins=0,pnl=0;
  for(let i=30;i<data.length-1;i++){
    let slice=data.slice(0,i);
    let s=signal(slice);
    if(s==="BUY"){
      trades++;
      let entry=data[i].close;
      let exit=data[i+1].close;
      let profit=(exit-entry)/entry*100;
      pnl+=profit;
      if(profit>0) wins++;
    }
  }
  return {trades,wins,winrate:trades?wins/trades*100:0,pnl};
}

// GTT SIMULATION
function simulateGTT(data,signal){
  let last=data.at(-1).close;
  let sl=signal==="BUY"?last*0.98:last*1.02;
  let tgt=signal==="BUY"?last*1.03:last*0.97;
  let status="Waiting";
  let next=data.at(-1);
  if(signal==="BUY"){
    if(next.low<=sl) status="SL Hit";
    else if(next.high>=tgt) status="Target Hit";
  }
  return status;
}

function render(){
  const date=document.getElementById("date").value;
  const search=document.getElementById("search").value.toLowerCase();
  let tbody="";
  for(let s in DB){
    if(search && !s.toLowerCase().includes(search)) continue;
    let data=DB[s];
    let idx=data.findIndex(d=>d.date===date);
    if(idx<30) continue;
    let slice=data.slice(0,idx+1);
    let sig=signal(slice);
    if(filter==="buy" && sig!=="BUY") continue;
    if(filter==="sell" && sig!=="SELL") continue;

    let bt=backtest(slice);
    let gtt=simulateGTT(slice,sig);

    tbody+=`
    <tr>
      <td>${s}</td>
      <td class="badge ${sig==="BUY"?"green":sig==="SELL"?"red":"orange"}">${sig}</td>
      <td>${sig}</td>
      <td>${slice.at(-1).close.toFixed(2)}</td>
      <td>${slice.at(-1).close.toFixed(2)}</td>
      <td>${(slice.at(-1).close*0.98).toFixed(2)}</td>
      <td>${(slice.at(-1).close*1.03).toFixed(2)}</td>
      <td>${gtt}</td>
      <td>${bt.trades}</td>
      <td>${bt.winrate.toFixed(1)}%</td>
      <td>${bt.pnl.toFixed(2)}%</td>
    </tr>`;
  }
  document.getElementById("tbody").innerHTML=tbody;
}

loadData();
</script>
</body>
</html>
