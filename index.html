<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stock Dashboard Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{margin:0;background:#0f172a;color:#e5e7eb;font-family:Arial}
header{background:#020617;padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
input,button{background:#1f2937;color:white;border:none;padding:6px 10px;border-radius:6px}
table{width:100%;border-collapse:collapse}
td,th{padding:8px;border-bottom:1px solid #1f2937;text-align:center;font-size:14px}
.pos{color:#22c55e;font-weight:bold}
.neg{color:#ef4444;font-weight:bold}
.card{margin:10px;background:#111827;padding:10px;border-radius:10px}
.remove{color:#f87171;cursor:pointer;font-weight:bold}
.modal{position:fixed;inset:0;background:#000a;display:none;align-items:center;justify-content:center}
</style>
</head>
<body>

<header>
  üìÖ <input type="date" id="datePicker">
  <button onclick="load()">Submit</button>

  üîç <input id="search" placeholder="Search">

  ‚ûï <input id="addStock" placeholder="Add stock">
  <button onclick="addStock()">Add</button>

  üîî Alert:
  <input id="alertSymbol" placeholder="SBIN">
  <select id="alertType"><option value="above">Above</option><option value="below">Below</option></select>
  <input id="alertPrice" type="number" placeholder="Price">
  <button onclick="setPriceAlert()">Set</button>

  <button onclick="exportXLSX()">Excel</button>
</header>

<div class="card">
<table>
<thead>
<tr>
<th>Stock</th><th>Low</th><th>High</th><th>Close</th><th>Volume</th>
<th onclick="sortByChange()">%</th><th>RSI</th><th>EMA</th><th>VWAP</th><th>‚ùå</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="modal" id="chartModal" onclick="closeChart()">
  <div style="background:#111827;padding:20px;width:90%;max-width:700px">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
// ===================== CONFIG =====================
const TELEGRAM_BOT_TOKEN = 8168507195:AAHXFWjfWqDZ4A4ZWnBIIsoc9wu2yp6uGmU;
const TELEGRAM_CHAT_ID   = Joneskys_Bot;
// ==================================================

let stocks = JSON.parse(localStorage.getItem("stocks")) || ["SBIN","TCS","RVNL"];
let tableData = [];
let alerts = JSON.parse(localStorage.getItem("alerts") || "[]");
let sortAsc = false;

document.getElementById("datePicker").valueAsDate = new Date();

function saveStocks(){ localStorage.setItem("stocks", JSON.stringify(stocks)); }

function addStock(){
  const s=document.getElementById("addStock").value.toUpperCase();
  if(s && !stocks.includes(s)){stocks.push(s);saveStocks();load();}
}

function removeStock(s){
  stocks=stocks.filter(x=>x!==s); saveStocks(); load();
}

document.getElementById("search").oninput = render;

async function fetchSeries(symbol){
  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.NS?range=1mo&interval=1d`;
  const proxy="https://api.allorigins.win/raw?url=";
  const res=await fetch(proxy+encodeURIComponent(url));
  const j=await res.json();
  const r=j.chart.result?.[0];
  if(!r) return null;
  const t=r.timestamp;
  const q=r.indicators.quote[0];
  let arr=[];
  for(let i=0;i<t.length;i++){
    if(q.close[i]) arr.push({t:t[i],open:q.open[i],high:q.high[i],low:q.low[i],close:q.close[i],volume:q.volume[i]});
  }
  return arr;
}

function rsi(values,p=14){
  if(values.length<p+1) return null;
  let gains=0,losses=0;
  for(let i=1;i<=p;i++){
    let d=values[i]-values[i-1];
    if(d>=0) gains+=d; else losses-=d;
  }
  let rs=gains/(losses||1);
  return 100-(100/(1+rs));
}

function ema(values,p=14){
  let k=2/(p+1),e=values[0];
  for(let i=1;i<values.length;i++) e=values[i]*k+e*(1-k);
  return e;
}

function vwap(c,v){
  let n=0,d=0;
  for(let i=0;i<c.length;i++){n+=c[i]*v[i];d+=v[i]}
  return n/d;
}

async function load(){
  tableData=[];
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="<tr><td colspan='10'>Loading...</td></tr>";

  for(let s of stocks){
    try{
      const series=await fetchSeries(s);
      if(!series||series.length<2) continue;

      const t=series.at(-1), p=series.at(-2);
      const closes=series.map(x=>x.close);
      const vols=series.map(x=>x.volume);

      tableData.push({
        symbol:s,
        ...t,
        change:(t.close-p.close)/p.close*100,
        rsi:rsi(closes),
        ema:ema(closes),
        vwap:vwap(closes,vols),
        series
      });
    }catch{}
  }
  render();
  checkAlerts();
}

function render(){
  const q=document.getElementById("search").value.toLowerCase();
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  tableData.filter(r=>!q||r.symbol.toLowerCase().includes(q))
  .forEach(r=>{
    tbody.innerHTML+=`
      <tr onclick="showChart('${r.symbol}')">
        <td>${r.symbol}</td>
        <td>${r.low.toFixed(2)}</td>
        <td>${r.high.toFixed(2)}</td>
        <td>${r.close.toFixed(2)}</td>
        <td>${r.volume.toLocaleString()}</td>
        <td class="${r.change>=0?'pos':'neg'}">${r.change.toFixed(2)}%</td>
        <td>${r.rsi?.toFixed(1)||"-"}</td>
        <td>${r.ema?.toFixed(1)||"-"}</td>
        <td>${r.vwap?.toFixed(1)||"-"}</td>
        <td class="remove" onclick="event.stopPropagation();removeStock('${r.symbol}')">‚úï</td>
      </tr>`;
  });
}

function sortByChange(){
  tableData.sort((a,b)=>sortAsc?a.change-b.change:b.change-a.change);
  sortAsc=!sortAsc; render();
}

// ===== Candlestick chart =====
let chart;
function showChart(sym){
  const r=tableData.find(x=>x.symbol===sym);
  const data=r.series.map(x=>({x:new Date(x.t*1000),o:x.open,h:x.high,l:x.low,c:x.close}));
  document.getElementById("chartModal").style.display="flex";
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"candlestick",
    data:{datasets:[{label:sym,data}]}
  });
}
function closeChart(){document.getElementById("chartModal").style.display="none"}

// ===== Excel export =====
function exportXLSX(){
  const ws=XLSX.utils.json_to_sheet(tableData.map(r=>({
    Stock:r.symbol,Low:r.low,High:r.high,Close:r.close,Volume:r.volume,
    Change:r.change.toFixed(2),RSI:r.rsi?.toFixed(2),EMA:r.ema?.toFixed(2),VWAP:r.vwap?.toFixed(2)
  })));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Stocks");
  XLSX.writeFile(wb,"stocks.xlsx");
}

// ===== Telegram Alerts =====
function setPriceAlert(){
  const sym=document.getElementById("alertSymbol").value.toUpperCase();
  const type=document.getElementById("alertType").value;
  const price=parseFloat(document.getElementById("alertPrice").value);
  if(!sym||!price) return alert("Invalid input");
  alerts.push({sym,type,price});
  localStorage.setItem("alerts",JSON.stringify(alerts));
  alert("Alert set");
}

function checkAlerts(){
  tableData.forEach(r=>{
    alerts.forEach((a,i)=>{
      if(a.sym!==r.symbol) return;
      if(a.type==="above" && r.close>=a.price) sendAlert(a,r.close,i);
      if(a.type==="below" && r.close<=a.price) sendAlert(a,r.close,i);
    });
  });
}

function sendAlert(a,price,index){
  const text=`üîî ALERT HIT\n${a.sym} ${a.type.toUpperCase()} ${a.price}\nLTP: ${price}`;
  fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:TELEGRAM_CHAT_ID,text})
  });
  alerts.splice(index,1);
  localStorage.setItem("alerts",JSON.stringify(alerts));
}

// auto refresh every 30s
setInterval(load,30000);
load();
</script>
</body>
</html>
