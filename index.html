<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stock Historical Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0f172a; --card:#111827; --border:#1f2937;
  --text:#e5e7eb; --green:#22c55e; --red:#ef4444;
}
body { margin:0; font-family:Arial; background:var(--bg); color:var(--text);}
header {background:#020617;padding:12px;}
.container {padding:16px;}
.card {background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
table {width:100%;border-collapse:collapse;}
th,td {padding:10px;border-bottom:1px solid var(--border);text-align:center;}
.pos {color:var(--green);font-weight:bold;}
.neg {color:var(--red);font-weight:bold;}
input,button {background:#1f2937;color:white;border:none;padding:6px 10px;border-radius:8px;}
th {cursor:pointer;}
</style>
</head>

<body>

<header>
  üìÖ Select Date:
  <input type="date" id="datePicker">
  <button onclick="exportCSV()">‚¨á Export CSV</button>
</header>

<div class="container">
  <div class="card">
    <h3>üìä Historical Stock Data</h3>
    <table>
      <thead>
        <tr>
          <th>Stock</th>
          <th>Low</th>
          <th>High</th>
          <th>Close</th>
          <th>Volume</th>
          <th onclick="sortByChange()">% Change ‚¨ç</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const stocks = ["IDEA","SBIN","TCS","RVNL","JPPOWER","HINDCOPPER","RBLBANK","HDFCBANK"];
let tableData = [];
let sortAsc = false;

const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);
document.getElementById("datePicker").valueAsDate = yesterday;

function toUnix(d){ return Math.floor(new Date(d).getTime()/1000); }

async function safeFetch(url){
  const proxies=[
    u=>"https://api.allorigins.win/raw?url="+encodeURIComponent(u),
    u=>"https://corsproxy.io/?"+encodeURIComponent(u),
    u=>"https://thingproxy.freeboard.io/fetch/"+u
  ];
  for(let p of proxies){
    try{
      let r=await fetch(p(url));
      if(r.ok) return await r.json();
    }catch{}
  }
  throw "All proxies failed";
}

async function fetchDaily(symbol,date){
  const start = toUnix(date) - 86400 * 10;
  const end   = toUnix(date) + 86400 * 2;
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.NS?period1=${start}&period2=${end}&interval=1d`;
  const json = await safeFetch(url);
  const r = json.chart?.result?.[0];
  if(!r) return null;

  const q = r.indicators.quote[0];
  let candles = [];
  for(let i=0;i<q.close.length;i++){
    if(q.close[i]){
      candles.push({
        close:q.close[i],
        low:q.low[i],
        high:q.high[i],
        volume:q.volume[i]
      });
    }
  }

  if(candles.length < 2) return null;

  const today = candles[candles.length - 1];
  const prev  = candles[candles.length - 2];

  return {
    ...today,
    prevClose: prev.close
  };
}

async function load(){
  tableData=[];
  const date = document.getElementById("datePicker").value;

  for(let s of stocks){
    try{
      const d = await fetchDaily(s,date);
      if(!d) continue;

      const ch = ((d.close - d.prevClose)/d.prevClose)*100;
      tableData.push({symbol:s,...d,change:ch});
    }catch{}
  }
  render();
}

function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML="";
  tableData.forEach(r=>{
    const cls = r.change>=0?"pos":"neg";
    tbody.innerHTML += `
      <tr>
        <td>${r.symbol}</td>
        <td>${r.low.toFixed(2)}</td>
        <td>${r.high.toFixed(2)}</td>
        <td>${r.close.toFixed(2)}</td>
        <td>${r.volume.toLocaleString()}</td>
        <td class="${cls}">${r.change>0?"+":""}${r.change.toFixed(2)}%</td>
      </tr>`;
  });
}

function sortByChange(){
  tableData.sort((a,b)=>sortAsc?a.change-b.change:b.change-a.change);
  sortAsc=!sortAsc;
  render();
}

function exportCSV(){
  let csv="Stock,Low,High,Close,Volume,Change\n";
  tableData.forEach(r=>{
    csv+=`${r.symbol},${r.low},${r.high},${r.close},${r.volume},${r.change.toFixed(2)}%\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="stocks.csv";
  a.click();
}

document.getElementById("datePicker").onchange = load;
load();
</script>

</body>
</html>
