<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stock Dashboard Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0f172a; --card:#111827; --border:#1f2937;
  --text:#e5e7eb; --green:#22c55e; --red:#ef4444; --blue:#3b82f6;
}
body { margin:0; font-family:Arial; background:var(--bg); color:var(--text);}
header {background:#020617;padding:12px;border-bottom:1px solid var(--border);}
.topbar {display:flex;gap:15px;font-size:14px;flex-wrap:wrap;}
.badge {background:#1f2937;padding:6px 12px;border-radius:10px;}
.container {padding:16px;}
.card {background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;}
table {width:100%;border-collapse:collapse;}
th,td {padding:12px;border-bottom:1px solid var(--border);text-align:center;}
th {cursor:pointer;}
.pos {color:var(--green);font-weight:bold;}
.neg {color:var(--red);font-weight:bold;}
.controls {display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
input,button {padding:8px 12px;border-radius:10px;border:none;font-size:14px;}
button {background:#1f2937;color:white;cursor:pointer;}
button.active {background:var(--blue);}
#chartModal {position:fixed;inset:0;background:#000c;display:none;align-items:center;justify-content:center;}
#chartBox {background:#111827;padding:20px;border-radius:16px;width:90%;max-width:700px;}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <div class="badge" id="nifty">Nifty: --</div>
    <div class="badge" id="sensex">Sensex: --</div>
    <div class="badge" id="usd">USD/INR: --</div>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="controls">
      <input id="search" placeholder="Search stock...">
      <button onclick="setFilter('all')" class="active" id="btn-all">All</button>
      <button onclick="setFilter('gainers')" id="btn-gainers">Gainers</button>
      <button onclick="setFilter('losers')" id="btn-losers">Losers</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Stock</th>
          <th>Low</th>
          <th>High</th>
          <th>LTP</th>
          <th onclick="sortByChange()">% Change ‚¨ç</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Chart Modal -->
<div id="chartModal" onclick="closeChart()">
  <div id="chartBox" onclick="event.stopPropagation()">
    <canvas id="chart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const stocks = [
  "IDEA","SBIN","TCS","RVNL","JPPOWER",
  "HINDCOPPER","RBLBANK","HDFCBANK","NTPC","ITC"
];

let data = [];
let filter = "all";
let sortAsc = false;

// === Fetch from Yahoo using working proxy ===
async function fetchQuote(symbol){
  const yahoo = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`;
  const proxy = "https://corsproxy.io/?";
  const res = await fetch(proxy + encodeURIComponent(yahoo));
  return await res.json();
}

// === Load Stocks ===
async function load(){
  data = [];
  for(let s of stocks){
    try {
      let r = (await fetchQuote(s + ".NS")).quoteResponse.result[0];
      if(!r) continue;
      data.push({
        s,
        low:r.regularMarketDayLow,
        high:r.regularMarketDayHigh,
        price:r.regularMarketPrice,
        change:r.regularMarketChangePercent
      });
    } catch(e) {
      console.log("Error", s);
    }
  }
  render();
}

// === Render Table ===
function render(){
  let q = document.getElementById("search").value.toLowerCase();
  let rows = data.filter(x=>{
    if(q && !x.s.toLowerCase().includes(q)) return false;
    if(filter==="gainers" && x.change < 0) return false;
    if(filter==="losers" && x.change >= 0) return false;
    return true;
  });

  let tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  rows.forEach(x=>{
    let cls = x.change >= 0 ? "pos" : "neg";
    tbody.innerHTML += `
      <tr onclick="showChart('${x.s}')">
        <td>${x.s}</td>
        <td>${x.low?.toFixed(2) || "-"}</td>
        <td>${x.high?.toFixed(2) || "-"}</td>
        <td>${x.price?.toFixed(2) || "-"}</td>
        <td class="${cls}">${x.change?.toFixed(2)}%</td>
      </tr>
    `;
  });
}

// === Filters ===
function setFilter(f){
  filter = f;
  document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn-"+f).classList.add("active");
  render();
}

// === Sorting ===
function sortByChange(){
  data.sort((a,b)=> sortAsc ? a.change - b.change : b.change - a.change);
  sortAsc = !sortAsc;
  render();
}

// === Search ===
document.getElementById("search").oninput = render;

// === Chart Popup ===
function showChart(sym){
  document.getElementById("chartModal").style.display="flex";
  let ctx = document.getElementById("chart").getContext("2d");
  new Chart(ctx,{
    type:"line",
    data:{labels:["1","2","3","4","5"],datasets:[{label:sym,data:[1,2,1,3,2],borderColor:"#3b82f6"}]},
    options:{responsive:true}
  });
}
function closeChart(){
  document.getElementById("chartModal").style.display="none";
}

// === Top Bar Market Data ===
async function loadMarket(){
  try {
    const n = (await fetchQuote("^NSEI")).quoteResponse.result[0];
    const s = (await fetchQuote("^BSESN")).quoteResponse.result[0];
    const u = (await fetchQuote("USDINR=X")).quoteResponse.result[0];

    document.getElementById("nifty").innerText  = "Nifty: " + n.regularMarketPrice.toFixed(2);
    document.getElementById("sensex").innerText = "Sensex: " + s.regularMarketPrice.toFixed(2);
    document.getElementById("usd").innerText    = "USD/INR: " + u.regularMarketPrice.toFixed(2);
  } catch(e){
    console.log("Market error");
  }
}

// === Start ===
load();
loadMarket();
setInterval(load, 20000);
setInterval(loadMarket, 60000);
</script>

</body>
</html>
