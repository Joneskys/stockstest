<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Market Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0f172a; --panel:#020617; --border:#1f2937; --text:#e5e7eb;
  --green:#22c55e; --red:#ef4444; --orange:#f59e0b;
}
body{margin:0;font-family:Inter,Arial;background:var(--bg);color:var(--text);}
header{position:sticky;top:0;background:var(--panel);padding:10px;border-bottom:1px solid var(--border);}
.controls{display:flex;gap:8px;flex-wrap:wrap;}
input,button{background:#0f172a;color:white;border:1px solid var(--border);padding:8px;border-radius:6px;}
button{cursor:pointer}
.container{padding:8px;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th,td{border:1px solid var(--border);padding:6px;text-align:center;}
th{position:sticky;top:60px;background:var(--panel);z-index:5;}
tr:nth-child(even){background:#0b1220;}
.green{color:var(--green);font-weight:bold;}
.red{color:var(--red);font-weight:bold;}
.orange{color:var(--orange);font-weight:bold;}
</style>
</head>
<body>

<header>
  <div class="controls">
    <input type="date" id="datePicker">
    <button onclick="render()">Submit</button>
    <input placeholder="Search stock..." id="search" oninput="render()">
    <button onclick="filter='buy';render()">Show only Buy Signals</button>
    <button onclick="filter='sell';render()">Show only Sell Signals</button>
    <button onclick="filter='all';render()">Show All</button>
  </div>
</header>

<div class="container">
  <table>
    <thead>
    <tr>
      <th>Stock</th><th>High</th><th>Low</th>
      <th>1W High</th><th>1W Low</th>
      <th>1M High</th><th>1M Low</th>
      <th>RSI</th><th>EMA9</th><th>EMA21</th>
      <th>Support</th><th>Resistance</th><th>Trend</th>
      <th>Signal</th><th>Buy</th><th>Sell</th><th>SL</th><th>Target</th><th>Hold</th>
    </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
// CONFIG
const API_BASE = "https://red-tooth-e4f7.lovelyideas-in.workers.dev/?symbol=";
const STOCKS = ["SAGILITY","GROWWGOLD","JPPOWER","IDEA","BSE","GROWWSILVER","HDFCBANK","SBIN","GREAVESCOT","NTPCGREEN","TCS","KIMS","MON100","HARAFIN","RBLBANK","IRIS","MEESHO","HINDCOPPER","RVNL"];

let DB = {};
let selectedDate=null;
let filter="all";

// HELPER: convert Yahoo API JSON → OHLC array
function parseYahoo(resp) {
  const r = resp.chart.result[0];
  const ts = r.timestamp;
  const q = r.indicators.quote[0];
  let arr = [];
  for (let i=0; i<ts.length; i++){
    if (q.open[i] == null) continue; // skip missing
    const d = new Date(ts[i]*1000).toISOString().slice(0,10);
    arr.push({
      date:d,
      open:q.open[i],
      high:q.high[i],
      low:q.low[i],
      close:q.close[i]
    });
  }
  return arr;
}

// LOAD DATA
async function loadData(){
  DB = {};
  for(let s of STOCKS){
    try {
      const res = await fetch(API_BASE + s);
      const json = await res.json();
      DB[s] = parseYahoo(json);
    } catch {
      DB[s] = []; // fallback empty
    }
  }
  selectedDate = latestDate();
  document.getElementById("datePicker").value = selectedDate;
  render();
}

function latestDate(){
  for(let s of STOCKS){
    if(DB[s]?.length){
      return DB[s].at(-1).date;
    }
  }
  return null;
}

// INDICATORS
function EMA(vals, p){
  if (!vals.length) return 0;
  const k=2/(p+1); let e=vals[0];
  for(let v of vals) e = v*k + e*(1-k);
  return e;
}
function RSI(vals,p=14){
  let g=0,l=0;
  for(let i=1;i<=p;i++){
    const d=vals[i]-vals[i-1];
    d>0?g+=d:l-=d;
  }
  const rs=g/(l||1);
  return 100-(100/(1+rs));
}

// STRATEGY
function getSignal(ema9,ema21,rsi,close,support,resistance){
  if(ema9>ema21 && rsi>55 && close>resistance*0.99) return "BUY";
  if(ema9<ema21 && rsi<45 && close<support*1.01) return "SELL";
  return "HOLD";
}

function render(){
  const tbody=document.getElementById("tbody");
  const search=document.getElementById("search").value.toLowerCase();
  tbody.innerHTML="";
  for(let stock of STOCKS){
    if(search && !stock.toLowerCase().includes(search)) continue;
    const data=DB[stock]||[];
    const idx=data.findIndex(d=>d.date==selectedDate);
    if(idx<25) continue;

    const slice=data.slice(0,idx+1);
    const today=slice.at(-1);

    const closes=slice.map(d=>d.close);
    const rsi=RSI(closes.slice(-15));
    const ema9=EMA(closes.slice(-9),9);
    const ema21=EMA(closes.slice(-21),21);

    const week=slice.slice(-6);
    const month=slice.slice(-21);

    const support=Math.min(...month.map(d=>d.low));
    const resistance=Math.max(...month.map(d=>d.high));

    const signal=getSignal(ema9,ema21,rsi,today.close,support,resistance);
    if(filter=="buy" && signal!="BUY") continue;
    if(filter=="sell" && signal!="SELL") continue;

    const trend = ema9>ema21?"Uptrend":ema9<ema21?"Downtrend":"Sideways";
    const trendClass = trend=="Uptrend"?"green":trend=="Downtrend"?"red":"orange";

    const buy=today.close;
    const sell=today.close;
    const sl = signal=="BUY"?buy*0.98:sell*1.02;
    const tgt= signal=="BUY"?buy*1.03:sell*0.97;

    tbody.innerHTML+=`
      <tr>
        <td>${stock}</td>
        <td>${today.high.toFixed(2)}</td>
        <td>${today.low.toFixed(2)}</td>
        <td>${Math.max(...week.map(x=>x.high)).toFixed(2)}</td>
        <td>${Math.min(...week.map(x=>x.low)).toFixed(2)}</td>
        <td>${Math.max(...month.map(x=>x.high)).toFixed(2)}</td>
        <td>${Math.min(...month.map(x=>x.low)).toFixed(2)}</td>
        <td>${rsi.toFixed(1)}</td>
        <td>${ema9.toFixed(2)}</td>
        <td>${ema21.toFixed(2)}</td>
        <td>${support.toFixed(2)}</td>
        <td>${resistance.toFixed(2)}</td>
        <td class="${trendClass}">${trend}</td>
        <td class="${signal==='BUY'?'green':signal==='SELL'?'red':'orange'}">${signal}</td>
        <td>${buy.toFixed(2)}</td>
        <td>${sell.toFixed(2)}</td>
        <td>${sl.toFixed(2)}</td>
        <td>${tgt.toFixed(2)}</td>
        <td>30–90 min</td>
      </tr>`;
  }
}

loadData();
</script>
</body>
</html>
