<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stock Dashboard Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA -->
<link rel="manifest" href="manifest.json">

<style>
:root {
  --bg:#0f172a; --card:#111827; --border:#1f2937;
  --text:#e5e7eb; --green:#22c55e; --red:#ef4444; --blue:#3b82f6;
}
body {margin:0;font-family:Arial;background:var(--bg);color:var(--text);}
header {background:#020617;padding:12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
.container {padding:16px;}
.card {background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;}
table {width:100%;border-collapse:collapse;}
th,td {padding:8px;border-bottom:1px solid var(--border);text-align:center;font-size:14px;}
th {cursor:pointer;}
.pos {color:var(--green);font-weight:bold;}
.neg {color:var(--red);font-weight:bold;}
input,button {background:#1f2937;color:white;border:none;padding:6px 10px;border-radius:8px;}
button {cursor:pointer;}
.controls {display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.remove {color:red;cursor:pointer;font-weight:bold;}
.spark {font-size:12px;opacity:.7;}
@media(max-width:600px){
  th,td{font-size:12px;padding:6px;}
}
</style>
</head>

<body>

<header>
  üìÖ Date:
  <input type="date" id="datePicker">
  <button onclick="applyDate()">Submit</button>

  üîç Search:
  <input id="search" placeholder="Filter stocks">

  ‚ûï Add Stock:
  <input id="addStock" placeholder="e.g. INFY">
  <button onclick="addStock()">Add</button>

  <button onclick="exportCSV()">‚¨á Export CSV</button>
</header>

<div class="container">
  <div class="card">
    <h3>üìä Historical Stock Dashboard</h3>
    <table>
      <thead>
        <tr>
          <th>Stock</th>
          <th>Low</th>
          <th>High</th>
          <th>Close</th>
          <th>Volume</th>
          <th>%</th>
          <th>RSI</th>
          <th>EMA</th>
          <th>VWAP</th>
          <th>Trend</th>
          <th>‚ùå</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
let stocks = JSON.parse(localStorage.getItem("stocks")) ||
["IDEA","SBIN","TCS","RVNL","JPPOWER","HINDCOPPER","RBLBANK","HDFCBANK"];

let tableData = [];

const yesterday = new Date();
yesterday.setDate(yesterday.getDate()-1);
document.getElementById("datePicker").valueAsDate = yesterday;

function saveStocks(){
  localStorage.setItem("stocks", JSON.stringify(stocks));
}

function addStock(){
  const s = document.getElementById("addStock").value.toUpperCase();
  if(s && !stocks.includes(s)){
    stocks.push(s);
    saveStocks();
    document.getElementById("addStock").value="";
    load();
  }
}

function removeStock(s){
  stocks = stocks.filter(x=>x!==s);
  saveStocks();
  load();
}

document.getElementById("search").oninput = render;

function toUnix(d){ return Math.floor(new Date(d).getTime()/1000); }

async function safeFetch(url){
  const proxies=[
    u=>"https://api.allorigins.win/raw?url="+encodeURIComponent(u),
    u=>"https://corsproxy.io/?"+encodeURIComponent(u),
    u=>"https://thingproxy.freeboard.io/fetch/"+u
  ];
  for(let p of proxies){
    try{
      const r=await fetch(p(url));
      if(r.ok) return await r.json();
    }catch{}
  }
  throw "fail";
}

async function fetchSeries(symbol,date){
  const start = toUnix(date)-86400*30;
  const end = toUnix(date)+86400*2;
  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.NS?period1=${start}&period2=${end}&interval=1d`;
  const json = await safeFetch(url);
  const r=json.chart?.result?.[0];
  if(!r) return null;

  const q=r.indicators.quote[0];
  let candles=[];
  for(let i=0;i<q.close.length;i++){
    if(q.close[i]) candles.push({
      close:q.close[i],low:q.low[i],high:q.high[i],volume:q.volume[i]
    });
  }
  return candles;
}

// indicators
function ema(values, period){
  let k=2/(period+1), ema=values[0];
  for(let i=1;i<values.length;i++) ema=values[i]*k+ema*(1-k);
  return ema;
}

function rsi(values, period=14){
  if(values.length<period+1) return null;
  let gains=0, losses=0;
  for(let i=1;i<=period;i++){
    let diff=values[i]-values[i-1];
    if(diff>=0) gains+=diff; else losses-=diff;
  }
  let rs = gains/(losses||1);
  return 100-(100/(1+rs));
}

function vwap(values, volumes){
  let num=0, den=0;
  for(let i=0;i<values.length;i++){
    num += values[i]*volumes[i];
    den += volumes[i];
  }
  return num/den;
}

async function load(){
  const date=document.getElementById("datePicker").value;
  tableData=[];
  document.getElementById("tbody").innerHTML="<tr><td colspan='11'>Loading...</td></tr>";

  for(let s of stocks){
    try{
      const series = await fetchSeries(s,date);
      if(!series || series.length<2) continue;

      const today=series[series.length-1];
      const prev=series[series.length-2];
      const closes=series.map(x=>x.close);
      const vols=series.map(x=>x.volume);

      tableData.push({
        symbol:s,
        ...today,
        change:((today.close-prev.close)/prev.close)*100,
        rsi:rsi(closes),
        ema:ema(closes,14),
        vwap:vwap(closes,vols),
        spark:closes.slice(-10)
      });
    }catch{}
  }
  render();
}

function render(){
  const q=document.getElementById("search").value.toLowerCase();
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";

  tableData.filter(r=>!q || r.symbol.toLowerCase().includes(q))
  .forEach(r=>{
    const cls=r.change>=0?"pos":"neg";
    const spark=r.spark.map(v=>v>r.spark[0]?"‚ñ¥":"‚ñæ").join("");

    tbody.innerHTML+=`
      <tr>
        <td>${r.symbol}</td>
        <td>${r.low.toFixed(2)}</td>
        <td>${r.high.toFixed(2)}</td>
        <td>${r.close.toFixed(2)}</td>
        <td>${r.volume.toLocaleString()}</td>
        <td class="${cls}">${r.change>0?"+":""}${r.change.toFixed(2)}%</td>
        <td>${r.rsi? r.rsi.toFixed(1):"-"}</td>
        <td>${r.ema? r.ema.toFixed(2):"-"}</td>
        <td>${r.vwap? r.vwap.toFixed(2):"-"}</td>
        <td class="spark">${spark}</td>
        <td class="remove" onclick="removeStock('${r.symbol}')">‚úï</td>
      </tr>`;
  });
}

function applyDate(){ load(); }

function exportCSV(){
  let csv="Stock,Low,High,Close,Volume,Change,RSI,EMA,VWAP\n";
  tableData.forEach(r=>{
    csv+=`${r.symbol},${r.low},${r.high},${r.close},${r.volume},${r.change.toFixed(2)},${r.rsi?.toFixed(2)},${r.ema?.toFixed(2)},${r.vwap?.toFixed(2)}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="stocks.csv";
  a.click();
}

// initial load
load();
</script>

</body>
</html>
