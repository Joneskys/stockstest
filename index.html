<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Stock Market Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* =========================
   THEME
========================= */
:root {
  --bg: #0f172a;
  --panel: #020617;
  --card: #111827;
  --border: #1f2937;
  --text: #e5e7eb;
  --green: #22c55e;
  --red: #ef4444;
  --orange: #f59e0b;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Inter, system-ui, Arial;
  background: var(--bg);
  color: var(--text);
}

/* =========================
   HEADER
========================= */
header {
  position: sticky;
  top: 0;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  padding: 10px;
  z-index: 20;
}

.controls {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

input, button {
  background: #0f172a;
  color: white;
  border: 1px solid var(--border);
  padding: 8px 10px;
  border-radius: 6px;
  font-size: 14px;
}

button {
  cursor: pointer;
}
button:hover {
  background: #1f2937;
}

/* =========================
   TABLE
========================= */
.container {
  padding: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th {
  position: sticky;
  top: 60px;
  background: #020617;
  z-index: 10;
}

th, td {
  border: 1px solid var(--border);
  padding: 6px;
  text-align: center;
  white-space: nowrap;
}

tr:nth-child(even) {
  background: #0b1220;
}

/* =========================
   COLORS
========================= */
.green { color: var(--green); font-weight: bold; }
.red { color: var(--red); font-weight: bold; }
.orange { color: var(--orange); font-weight: bold; }

@media(max-width: 900px){
  table { font-size: 11px; }
}
</style>
</head>
<body>

<header>
  <div class="controls">
    <input type="date" id="datePicker">
    <button onclick="applyDate()">Submit</button>
    <input type="text" id="search" placeholder="Search stock..." oninput="render()">
    <button onclick="filter='buy';render()">Show only Buy Signals</button>
    <button onclick="filter='sell';render()">Show only Sell Signals</button>
    <button onclick="filter='all';render()">Show All</button>
  </div>
</header>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>Stock</th>
        <th>Today High</th>
        <th>Today Low</th>
        <th>1W High</th>
        <th>1W Low</th>
        <th>1M High</th>
        <th>1M Low</th>
        <th>RSI</th>
        <th>EMA9</th>
        <th>EMA21</th>
        <th>Support</th>
        <th>Resistance</th>
        <th>Trend</th>
        <th>Signal</th>
        <th>Buy</th>
        <th>Sell</th>
        <th>SL</th>
        <th>Target</th>
        <th>Hold</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
// =============================================
// CONFIG
// =============================================
const API = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";

const STOCKS = [
  "SAGILITY","GROWWGOLD","JPPOWER","IDEA","BSE","GROWWSILVER",
  "HDFCBANK","SBIN","GREAVESCOT","NTPCGREEN","TCS","KIMS",
  "MON100","HARAFIN","RBLBANK","IRIS","MEESHO","HINDCOPPER","RVNL"
];

let DB = {};
let selectedDate = null;
let filter = "all";

// =============================================
// DATA LOADING
// =============================================
async function loadData() {
  try {
    const res = await fetch(API);
    const json = await res.json();
    DB = json;
    console.log("Loaded from Worker");
  } catch {
    console.warn("Worker failed, using mock data");
    generateMockData();
  }

  selectedDate = getLatestDate();
  document.getElementById("datePicker").value = selectedDate;
  render();
}

// =============================================
// MOCK DATA GENERATOR (30–60 DAYS)
// =============================================
function generateMockData() {
  const today = new Date();
  STOCKS.forEach(stock => {
    let price = 100 + Math.random()*100;
    DB[stock] = [];

    for (let i = 60; i >= 0; i--) {
      let d = new Date(today);
      d.setDate(today.getDate() - i);

      let open = price;
      let close = open + (Math.random()-0.5)*5;
      let high = Math.max(open, close) + Math.random()*2;
      let low  = Math.min(open, close) - Math.random()*2;

      price = close;
      DB[stock].push({
        date: d.toISOString().slice(0,10),
        open, high, low, close
      });
    }
  });
}

// =============================================
// HELPERS
// =============================================
function getLatestDate() {
  const first = Object.keys(DB)[0];
  return DB[first].at(-1).date;
}

function applyDate() {
  selectedDate = document.getElementById("datePicker").value;
  render();
}

// =============================================
// INDICATORS
// =============================================
function EMA(values, period) {
  const k = 2 / (period + 1);
  let ema = values[0];
  values.forEach(v => ema = v * k + ema * (1 - k));
  return ema;
}

function RSI(values, period = 14) {
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    const diff = values[i] - values[i - 1];
    diff > 0 ? gains += diff : losses -= diff;
  }
  const rs = gains / (losses || 1);
  return 100 - (100 / (1 + rs));
}

// =============================================
// STRATEGY ENGINE
// =============================================
function getSignal(ema9, ema21, rsi, close, resistance, support) {
  if (ema9 > ema21 && rsi > 55 && close > resistance * 0.99) return "BUY";
  if (ema9 < ema21 && rsi < 45 && close < support * 1.01) return "SELL";
  return "HOLD";
}

// =============================================
// RENDER TABLE
// =============================================
function render() {
  const tbody = document.getElementById("tbody");
  const search = document.getElementById("search").value.toLowerCase();
  tbody.innerHTML = "";

  for (let stock in DB) {
    if (search && !stock.toLowerCase().includes(search)) continue;

    const data = DB[stock];
    const idx = selectedDate
      ? data.findIndex(d => d.date === selectedDate)
      : data.length - 1;

    if (idx < 25) continue;

    const slice = data.slice(0, idx + 1);
    const today = slice.at(-1);

    const closes = slice.map(d => d.close);

    const ema9 = EMA(closes.slice(-9), 9);
    const ema21 = EMA(closes.slice(-21), 21);
    const rsi = RSI(closes.slice(-15));

    const week = slice.slice(-6);
    const month = slice.slice(-21);

    const support = Math.min(...month.map(d => d.low));
    const resistance = Math.max(...month.map(d => d.high));

    const signal = getSignal(ema9, ema21, rsi, today.close, resistance, support);
    if (filter === "buy" && signal !== "BUY") continue;
    if (filter === "sell" && signal !== "SELL") continue;

    const trend = ema9 > ema21 ? "Uptrend" : ema9 < ema21 ? "Downtrend" : "Sideways";
    const trendClass = trend === "Uptrend" ? "green" : trend === "Downtrend" ? "red" : "orange";

    const buy = today.close;
    const sell = today.close;
    const sl = signal === "BUY" ? buy * 0.98 : sell * 1.02;
    const target = signal === "BUY" ? buy * 1.03 : sell * 0.97;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${stock}</td>
      <td>${today.high.toFixed(2)}</td>
      <td>${today.low.toFixed(2)}</td>
      <td>${Math.max(...week.map(x=>x.high)).toFixed(2)}</td>
      <td>${Math.min(...week.map(x=>x.low)).toFixed(2)}</td>
      <td>${Math.max(...month.map(x=>x.high)).toFixed(2)}</td>
      <td>${Math.min(...month.map(x=>x.low)).toFixed(2)}</td>
      <td>${rsi.toFixed(1)}</td>
      <td>${ema9.toFixed(2)}</td>
      <td>${ema21.toFixed(2)}</td>
      <td>${support.toFixed(2)}</td>
      <td>${resistance.toFixed(2)}</td>
      <td class="${trendClass}">${trend}</td>
      <td class="${signal==="BUY"?"green":signal==="SELL"?"red":"orange"}">${signal}</td>
      <td>${buy.toFixed(2)}</td>
      <td>${sell.toFixed(2)}</td>
      <td>${sl.toFixed(2)}</td>
      <td>${target.toFixed(2)}</td>
      <td>30–90 min</td>
    `;
    tbody.appendChild(row);
  }
}

// =============================================
loadData();
</script>
</body>
</html>
