<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Professional Stock Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#0f172a;--panel:#020617;--border:#1f2937;--text:#e5e7eb;
  --green:#22c55e;--red:#ef4444;--orange:#f59e0b;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);}
header{position:sticky;top:0;background:var(--panel);padding:10px;border-bottom:1px solid var(--border);z-index:99}
.controls{display:flex;gap:8px;flex-wrap:wrap}
input,button{background:#0f172a;color:white;border:1px solid var(--border);padding:7px;border-radius:6px}
button:hover{background:#1f2937;cursor:pointer}

.topbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;padding:10px}
.card{background:#020617;border:1px solid var(--border);padding:10px;border-radius:12px;text-align:center}
.big{font-size:20px;font-weight:bold}

.container{padding:10px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid var(--border);padding:6px;text-align:center;white-space:nowrap}
th{position:sticky;top:70px;background:#020617}
tr:nth-child(even){background:#0b1220}

.green{color:#22c55e;font-weight:bold}
.red{color:#ef4444;font-weight:bold}
.orange{color:#f59e0b;font-weight:bold}
.small{font-size:10px;opacity:.7}

.popup{
  position:fixed;bottom:20px;right:20px;
  background:#020617;border:1px solid var(--border);
  padding:12px;border-radius:10px;display:none;
}
.popup button{margin-top:6px;width:100%}
</style>
</head>
<body>

<!-- LIVE MCX PANEL -->
<div class="topbar">
  <div class="card">Gold 24K 10g<div class="big" id="gold">--</div></div>
  <div class="card">Silver 1kg<div class="big" id="silver">--</div></div>
  <div class="card">Copper<div class="big" id="copper">--</div></div>
  <div class="card">USD → INR<div class="big" id="usd">--</div></div>
</div>

<header>
  <div class="controls">
    <input type="date" id="date">
    <button onclick="render()">Submit</button>
    <input id="search" placeholder="Search stock..." oninput="render()">
    <button onclick="filter='buy';render()">Only Buy</button>
    <button onclick="filter='sell';render()">Only Sell</button>
    <button onclick="filter='all';render()">All</button>
  </div>
</header>

<div class="container">
<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th>
<th>Trend</th><th>Signal</th>
<th>Trade</th><th>SL</th><th>Target</th><th>Hold</th><th>GTT</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="popup" id="popup">
  <div id="popupText"></div>
  <button onclick="popup.style.display='none'">Close</button>
</div>

<script>
// ================= CONFIG =================
const STOCK_API = "https://red-tooth-e4f7.lovelyideas-in.workers.dev/?symbol=";
const MCX_API   = "https://red-tooth-e4f7.lovelyideas-in.workers.dev/mcx";

const STOCKS = [
"SAGILITY","GROWWGOLD","JPPOWER","IDEA","CUPID","BSE","GROWWSILVER",
"HDFCBANK","SBIN","GREAVESCOT","NTPCGREEN","TCS","KIMS","MON100",
"HARAFIN","RBLBANK","IRIS","MEESHO","HINDCOPPER","RVNL","ORIENTTECH"
];

let DB={}, filter="all", lastSignals={};

// ================= LIVE MCX PANEL =================
async function loadLive(){
  try{
    const r = await fetch(MCX_API);
    const d = await r.json();
    if(!d || d.error) throw "bad";

    gold.textContent   = "₹" + d.gold_10g.toLocaleString();
    silver.textContent = "₹" + d.silver_1kg.toLocaleString();
    copper.textContent = "₹" + d.copper_1kg.toLocaleString();
    usd.textContent    = "₹" + d.usd_inr.toFixed(2);
  } catch {
    // Fallback values (never blank)
    gold.textContent   = "₹72,000";
    silver.textContent = "₹88,000";
    copper.textContent = "₹780";
    usd.textContent    = "₹83.10";
  }
}
setInterval(loadLive, 30000);
loadLive();

// ================= DATA LOAD =================
async function load(){
  for(let s of STOCKS){
    try{
      const j = await (await fetch(STOCK_API+s)).json();
      DB[s] = normalize(j) || mock();
    }catch{
      DB[s] = mock();
    }
  }
  date.value = latestDate();
  render();
}

function normalize(j){
  try{
    const r=j.chart.result[0];
    const ts=r.timestamp,q=r.indicators.quote[0];
    return ts.map((t,i)=>q.open[i]==null?null:{
      date:new Date(t*1000).toISOString().slice(0,10),
      open:q.open[i],high:q.high[i],low:q.low[i],
      close:q.close[i],volume:q.volume?q.volume[i]:1e6
    }).filter(Boolean);
  }catch{return null;}
}

function latestDate(){ for(let s of STOCKS) if(DB[s]?.length) return DB[s].at(-1).date; }

// ================= MOCK =================
function mock(){
  let arr=[],p=100+Math.random()*200;
  for(let i=60;i>=0;i--){
    let d=new Date();d.setDate(d.getDate()-i);
    let o=p,c=o+(Math.random()-0.5)*6;
    arr.push({date:d.toISOString().slice(0,10),open:o,high:o+2,low:o-2,close:c,volume:1e6});
    p=c;
  }
  return arr;
}

// ================= INDICATORS =================
const EMA=(a,p)=>{let k=2/(p+1),e=a[0];a.forEach(v=>e=v*k+e*(1-k));return e;}
const RSI=(a,p=14)=>{let g=0,l=0;for(let i=1;i<=p;i++){let d=a[i]-a[i-1];d>0?g+=d:l-=d;}let rs=g/(l||1);return 100-(100/(1+rs));}

// ================= STRATEGY =================
function signal(e9,e21,rsi,c,s,r){
  if(e9>e21 && rsi>55 && c>r*0.99) return "BUY";
  if(e9<e21 && rsi<45 && c<s*1.01) return "SELL";
  return "HOLD";
}
function gtt(t,sig){
  let sl=sig==="BUY"?t.close*0.98:t.close*1.02;
  let tgt=sig==="BUY"?t.close*1.03:t.close*0.97;
  if(t.low<=sl) return "SL Hit";
  if(t.high>=tgt) return "Target Hit";
  return "Waiting";
}

// ================= ALERT =================
function alertSignal(stock,sig){
  if(lastSignals[stock]===sig || sig==="HOLD") return;
  lastSignals[stock]=sig;
  popupText.textContent = `${stock}: ${sig} Signal`;
  popup.style.display="block";
  new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play();
}

// ================= RENDER =================
function render(){
  const dVal = date.value;
  const search = document.getElementById("search").value.toLowerCase();
  let html="";

  for(let s of STOCKS){
    if(search && !s.toLowerCase().includes(search)) continue;
    let d=DB[s]; if(!d||d.length<30) continue;

    let idx=d.findIndex(x=>x.date===dVal);
    if(idx<30) idx=d.length-1;

    let slice=d.slice(0,idx+1), t=slice.at(-1);
    let closes=slice.map(x=>x.close);

    let ema9=EMA(closes.slice(-9),9),
        ema21=EMA(closes.slice(-21),21),
        rsi=RSI(closes.slice(-15));

    let week=slice.slice(-6), month=slice.slice(-21);
    let support=Math.min(...month.map(x=>x.low)),
        resistance=Math.max(...month.map(x=>x.high));

    let sig=signal(ema9,ema21,rsi,t.close,support,resistance);

    if(filter==="buy" && sig!=="BUY") continue;
    if(filter==="sell" && sig!=="SELL") continue;

    alertSignal(s,sig);

    let trend=ema9>ema21?"Uptrend":ema9<ema21?"Downtrend":"Sideways";
    let cls=trend==="Uptrend"?"green":trend==="Downtrend"?"red":"orange";
    let pct=((t.close-t.open)/t.open*100).toFixed(2);

    html+=`<tr>
      <td>${s}</td>
      <td>${t.close.toFixed(2)}</td>
      <td><span class="small">L:${t.low.toFixed(1)} H:${t.high.toFixed(1)} ${pct}%</span></td>
      <td><span class="small">L:${Math.min(...week.map(x=>x.low)).toFixed(1)} H:${Math.max(...week.map(x=>x.high)).toFixed(1)}</span></td>
      <td><span class="small">L:${Math.min(...month.map(x=>x.low)).toFixed(1)} H:${Math.max(...month.map(x=>x.high)).toFixed(1)}</span></td>
      <td>${rsi.toFixed(1)}</td>
      <td>${ema9.toFixed(2)}</td>
      <td>${ema21.toFixed(2)}</td>
      <td>${support.toFixed(2)}</td>
      <td>${resistance.toFixed(2)}</td>
      <td class="${cls}">${trend}</td>
      <td class="${sig==="BUY"?"green":sig==="SELL"?"red":"orange"}">${sig}</td>
      <td>${t.close.toFixed(2)}</td>
      <td>${(t.close*(sig==="BUY"?0.98:1.02)).toFixed(2)}</td>
      <td>${(t.close*(sig==="BUY"?1.03:0.97)).toFixed(2)}</td>
      <td>30–90m</td>
      <td>${gtt(t,sig)}</td>
    </tr>`;
  }
  tbody.innerHTML = html;
}

load();
</script>
</body>
</html>
