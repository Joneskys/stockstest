<!DOCTYPE html>
<html>
<head>
<title>Ultimate Trading Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{background:#020617;color:white;font-family:Arial;padding:10px}
table{width:100%;border-collapse:collapse;font-size:11px}
th,td{padding:4px;border-bottom:1px solid #1e293b;text-align:center}
.green{color:#22c55e;font-weight:bold}
.red{color:#ef4444;font-weight:bold}
.yellow{color:#facc15;font-weight:bold}
button{background:#1e293b;color:white;border:none;padding:3px 6px;border-radius:5px;cursor:pointer;font-size:11px}
input,select{background:#1e293b;color:white;border:none;padding:3px;border-radius:5px;font-size:11px}
.panel{background:#0f172a;padding:6px;border-radius:8px;margin-bottom:6px;font-size:12px}
</style>
</head>
<body>

<h3>ðŸ“Š Pro Trading Dashboard</h3>

<div class="panel">
Strategy:
<select id="preset" onchange="applyPreset()">
  <option value="conservative">Conservative</option>
  <option value="balanced" selected>Balanced</option>
  <option value="aggressive">Aggressive</option>
</select>
Buy RSI <input id="buyRsi" value="35" size="3">
Sell RSI <input id="sellRsi" value="70" size="3">
RR â‰¥ <input id="rr" value="1.5" size="3">
<button onclick="loadData()">Apply</button>
<button onclick="exportReport()">Export Report</button>
</div>

<table>
<thead>
<tr>
<th>Stock</th><th>Close</th><th>%</th>
<th>RSI</th><th>EMA</th>
<th>S1</th><th>S2</th><th>R1</th><th>R2</th>
<th>Intraday</th><th>Delivery</th><th>GTT</th>
<th>AI%</th><th>Win%</th>
<th>ChatGPT</th><th>Groww</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const WORKER = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";

const stocks = [
"SAGILITY","GROWWGOLD","JPPOWER","IDEA","BSE","GROWWSILVER",
"HDFCBANK","SBIN","GREAVESCOT","NTPCGREEN","TCS","KIMS","MON100",
"HARAFIN","RBLBANK","IRIS","MEESHO","HINDCOPPER","RVNL","CUPID"
];

let report = [];

function applyPreset(){
  const p=preset.value;
  if(p=="conservative"){buyRsi.value=30;sellRsi.value=75;rr.value=2;}
  if(p=="balanced"){buyRsi.value=35;sellRsi.value=70;rr.value=1.5;}
  if(p=="aggressive"){buyRsi.value=40;sellRsi.value=65;rr.value=1.2;}
}

function EMA(v,p=14){let k=2/(p+1),e=v[0];for(let i=1;i<v.length;i++)e=v[i]*k+e*(1-k);return e;}
function RSI(v,p=14){let g=0,l=0;for(let i=v.length-p;i<v.length-1;i++){let d=v[i+1]-v[i];d>0?g+=d:l-=d;}let rs=g/(l||1);return 100-(100/(1+rs));}

function backtest(closes,buy){
  let wins=0,trades=0;
  for(let i=20;i<closes.length-5;i++){
    let r=RSI(closes.slice(i-14,i+1));
    if(r<buy){
      trades++;
      if(Math.max(...closes.slice(i+1,i+6)) > closes[i]*1.02) wins++;
    }
  }
  return trades?Math.round(wins/trades*100):0;
}

// ML-like probability
function aiScore(rsi,trend,nearSup){
  let score=50;
  if(rsi<40) score+=20;
  if(rsi>70) score-=15;
  if(trend) score+=10;
  if(nearSup) score+=10;
  return Math.max(0,Math.min(100,score));
}

async function loadData(){
  tbody.innerHTML="";
  report=[];
  for(const s of stocks){
    try{
      const res=await fetch(`${WORKER}?symbol=${s}`);
      const json=await res.json();
      const q=json.chart?.result?.[0]?.indicators?.quote?.[0];
      if(!q) continue;

      const closes=q.close.filter(x=>x);
      const highs=q.high.filter(x=>x);
      const lows=q.low.filter(x=>x);

      const close=closes.at(-1);
      const prev=closes.at(-2);
      const pct=((close-prev)/prev*100).toFixed(2);
      const rsi=RSI(closes.slice(-20));
      const ema=EMA(closes.slice(-20));

      const s1=Math.min(...lows.slice(-10));
      const s2=Math.min(...lows.slice(-20));
      const r1=Math.max(...highs.slice(-10));
      const r2=Math.max(...highs.slice(-20));

      const win=backtest(closes,+buyRsi.value);

      const nearSup=Math.abs(close-s1)/close<0.02;
      const trend=close>ema;
      const ai=aiScore(rsi,trend,nearSup);

      let intraday="No Trade",delivery="Hold",gtt="Wait";

      if(rsi<buyRsi.value){
        intraday=`BUY @ ${close.toFixed(2)} | SL ${(close*0.97).toFixed(2)} | TGT ${(close*1.05).toFixed(2)} | Hold 15-60m`;
        delivery=`BUY | Hold 1-5 days`;
        gtt=`Buy above ${r1.toFixed(2)}`;
      }
      if(rsi>sellRsi.value){
        intraday=`SELL @ ${close.toFixed(2)} | SL ${(close*1.03).toFixed(2)} | TGT ${(close*0.95).toFixed(2)} | Hold 15-60m`;
        gtt=`Sell below ${s1.toFixed(2)}`;
      }

      const chat=`https://chat.openai.com/?q=Analyze ${s} stock for intraday and delivery strategy`;
      const grow=`https://groww.in/stocks/${s.toLowerCase().replace(/[^a-z0-9]/g,"")}`;

      report.push({s,close,pct,rsi,ema,s1,s2,r1,r2,win,ai});

      tbody.innerHTML+=`
      <tr>
        <td>${s}</td>
        <td>${close.toFixed(2)}</td>
        <td class="${pct>=0?'green':'red'}">${pct}%</td>
        <td>${rsi.toFixed(1)}</td>
        <td>${ema.toFixed(1)}</td>
        <td>${s1.toFixed(1)}</td><td>${s2.toFixed(1)}</td>
        <td>${r1.toFixed(1)}</td><td>${r2.toFixed(1)}</td>
        <td>${intraday}</td>
        <td>${delivery}</td>
        <td>${gtt}</td>
        <td>${ai}</td>
        <td>${win}%</td>
        <td><a target="_blank" href="${chat}"><button>Ask</button></a></td>
        <td><a target="_blank" href="${grow}"><button>Trade</button></a></td>
      </tr>`;
    }catch(e){}
  }
}

function exportReport(){
  let csv="Stock,Close,%,RSI,EMA,S1,S2,R1,R2,Win%,AI\n";
  report.forEach(r=>{
    csv+=`${r.s},${r.close},${r.pct},${r.rsi},${r.ema},${r.s1},${r.s2},${r.r1},${r.r2},${r.win},${r.ai}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="backtest_report.csv";
  a.click();
}

applyPreset();
loadData();
setInterval(loadData,60000);
</script>
</body>
</html>
