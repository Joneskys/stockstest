<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Full Trading Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#0b1220;--panel:#020617;--border:#1f2937;--text:#e5e7eb;
  --green:#22c55e;--red:#ef4444;--orange:#f59e0b;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);}
header,nav{background:var(--panel);border-bottom:1px solid var(--border);padding:10px;position:sticky;top:0;z-index:50}
nav button{margin-right:6px}
button,input{background:#0f172a;color:white;border:1px solid var(--border);padding:6px;border-radius:6px}
button:hover{background:#1f2937;cursor:pointer}

.tab{display:none;padding:10px}
.tab.active{display:block}

table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid var(--border);padding:6px;text-align:center}
th{background:#020617;position:sticky;top:80px}

.green{color:var(--green);font-weight:bold}
.red{color:var(--red);font-weight:bold}
.orange{color:var(--orange);font-weight:bold}

.popup{position:fixed;bottom:20px;right:20px;background:#020617;border:1px solid var(--border);
padding:12px;border-radius:10px;display:none}
canvas{background:#0b1220;border:1px solid #1f2937}
</style>
</head>
<body>

<!-- NAVIGATION -->
<nav>
  <button onclick="showTab('scanner')">ðŸ“Š Scanner</button>
  <button onclick="showTab('chart')">ðŸ“ˆ Chart</button>
  <button onclick="showTab('trading')">ðŸ’¹ Paper Trading</button>
  <button onclick="showTab('portfolio')">ðŸ“‚ Portfolio</button>
</nav>

<!-- SCANNER -->
<div id="scanner" class="tab active">
  <h3>Stock Scanner</h3>
  <input placeholder="Search..." id="search" oninput="render()">
  <button onclick="filter='buy';render()">Only Buy</button>
  <button onclick="filter='sell';render()">Only Sell</button>
  <button onclick="filter='all';render()">All</button>

  <table>
    <thead>
      <tr>
        <th>Stock</th><th>Price</th><th>RSI</th><th>EMA9</th><th>EMA21</th>
        <th>Support</th><th>Resistance</th>
        <th>Trend</th><th>Signal</th><th>Chart</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- CHART -->
<div id="chart" class="tab">
  <h3 id="chartTitle">Chart</h3>
  <canvas id="canvas" width="900" height="400"></canvas>
</div>

<!-- PAPER TRADING -->
<div id="trading" class="tab">
  <h3>Paper Trading Desk</h3>
  <select id="tradeStock"></select>
  <input id="qty" type="number" value="10">
  <button onclick="placeTrade('BUY')">BUY</button>
  <button onclick="placeTrade('SELL')">SELL</button>
  <h4>Trades</h4>
  <ul id="trades"></ul>
</div>

<!-- PORTFOLIO -->
<div id="portfolio" class="tab">
  <h3>Portfolio</h3>
  <div id="portfolioData"></div>
</div>

<div class="popup" id="popup"></div>

<script>
// ============ CONFIG ============
const API="https://red-tooth-e4f7.lovelyideas-in.workers.dev/?symbol=";
const STOCKS=["SAGILITY","GROWWGOLD","JPPOWER","IDEA","BSE","GROWWSILVER","HDFCBANK","SBIN","GREAVESCOT","NTPCGREEN","TCS","KIMS","MON100","HARAFIN","RBLBANK","IRIS","MEESHO","HINDCOPPER","RVNL"];

let DB={},filter="all",selectedStock=null,trades=[];

// ============ TAB CONTROL ============
function showTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// ============ DATA ============
async function load(){
  for(let s of STOCKS){
    try{
      const r=await fetch(API+s);
      const j=await r.json();
      DB[s]=parseYahoo(j);
    }catch{ DB[s]=mock(); }
  }
  buildDropdown();
  render();
}

function parseYahoo(j){
  const r=j.chart.result[0];
  const ts=r.timestamp,q=r.indicators.quote[0];
  return ts.map((t,i)=>q.open[i]==null?null:{
    date:new Date(t*1000).toISOString().slice(0,10),
    open:q.open[i],high:q.high[i],low:q.low[i],
    close:q.close[i],volume:q.volume?q.volume[i]:1e6
  }).filter(Boolean);
}

function mock(){
  let arr=[],p=100;
  for(let i=60;i>=0;i--){
    let d=new Date();d.setDate(d.getDate()-i);
    let o=p,c=o+(Math.random()-0.5)*4;
    arr.push({date:d.toISOString().slice(0,10),open:o,high:o+3,low:o-3,close:c,volume:1e6});
    p=c;
  }
  return arr;
}

// ============ INDICATORS ============
const EMA=(a,p)=>{let k=2/(p+1),e=a[0];a.forEach(v=>e=v*k+e*(1-k));return e;}
const RSI=(a,p=14)=>{let g=0,l=0;for(let i=1;i<=p;i++){let d=a[i]-a[i-1];d>0?g+=d:l-=d;}let rs=g/(l||1);return 100-(100/(1+rs));}

// ============ STRATEGY ============
function signal(e9,e21,rsi,c,s,r){
  if(e9>e21 && rsi>55 && c>r*0.99) return "BUY";
  if(e9<e21 && rsi<45 && c<s*1.01) return "SELL";
  return "HOLD";
}

// ============ RENDER ============
function render(){
  const tbody=document.getElementById("tbody");
  const search=document.getElementById("search").value.toLowerCase();
  tbody.innerHTML="";
  for(let s of STOCKS){
    if(search && !s.toLowerCase().includes(search)) continue;
    let d=DB[s]; if(!d||d.length<30) continue;
    let slice=d.slice(-60),today=slice.at(-1);
    let closes=slice.map(x=>x.close);
    let ema9=EMA(closes.slice(-9),9);
    let ema21=EMA(closes.slice(-21),21);
    let rsi=RSI(closes.slice(-15));
    let support=Math.min(...slice.slice(-21).map(x=>x.low));
    let resistance=Math.max(...slice.slice(-21).map(x=>x.high));
    let sig=signal(ema9,ema21,rsi,today.close,support,resistance);
    if(filter==="buy" && sig!=="BUY") continue;
    if(filter==="sell" && sig!=="SELL") continue;

    tbody.innerHTML+=`
      <tr>
        <td>${s}</td>
        <td>${today.close.toFixed(2)}</td>
        <td>${rsi.toFixed(1)}</td>
        <td>${ema9.toFixed(2)}</td>
        <td>${ema21.toFixed(2)}</td>
        <td>${support.toFixed(2)}</td>
        <td>${resistance.toFixed(2)}</td>
        <td class="${ema9>ema21?'green':ema9<ema21?'red':'orange'}">
          ${ema9>ema21?'Uptrend':ema9<ema21?'Downtrend':'Sideways'}
        </td>
        <td class="${sig==='BUY'?'green':sig==='SELL'?'red':'orange'}">${sig}</td>
        <td><button onclick="openChart('${s}')">View</button></td>
      </tr>`;
  }
}

// ============ CHART ============
function openChart(stock){
  showTab("chart");
  chartTitle.innerText=stock;
  let ctx=canvas.getContext("2d");
  ctx.clearRect(0,0,900,400);
  let d=DB[stock].slice(-60);
  let max=Math.max(...d.map(x=>x.high));
  let min=Math.min(...d.map(x=>x.low));
  d.forEach((c,i)=>{
    let x=i*14;
    let yH=400-(c.high-min)/(max-min)*380;
    let yL=400-(c.low-min)/(max-min)*380;
    ctx.strokeStyle="#888";ctx.beginPath();ctx.moveTo(x,yH);ctx.lineTo(x,yL);ctx.stroke();
    ctx.fillStyle=c.close>=c.open?"#22c55e":"#ef4444";
    let yO=400-(c.open-min)/(max-min)*380;
    let yC=400-(c.close-min)/(max-min)*380;
    ctx.fillRect(x-3,Math.min(yO,yC),6,Math.abs(yO-yC)+1);
  });
}

// ============ PAPER TRADING ============
function buildDropdown(){
  tradeStock.innerHTML=STOCKS.map(s=>`<option>${s}</option>`).join("");
}
function placeTrade(type){
  let s=tradeStock.value;
  let price=DB[s].at(-1).close;
  trades.push({s,type,qty:+qty.value,price});
  updateTrades();
}
function updateTrades(){
  tradesEl.innerHTML="";
  let pnl=0;
  trades.forEach(t=>{
    let current=DB[t.s].at(-1).close;
    let p=(t.type==="BUY"?current-t.price:t.price-current)*t.qty;
    pnl+=p;
    tradesEl.innerHTML+=`<li>${t.s} ${t.type} ${t.qty} @ ${t.price.toFixed(2)} | P&L: ${p.toFixed(2)}</li>`;
  });
  portfolioData.innerHTML="Total P&L: â‚¹"+pnl.toFixed(2);
}

// INIT
load();
</script>
</body>
</html>
